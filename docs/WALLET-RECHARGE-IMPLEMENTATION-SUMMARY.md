# é’±åŒ…å……å€¼é—­ç¯å®ç°æ€»ç»“

## å®æ–½æ¦‚è¦

æœ¬æ¬¡å®æ–½å®Œæˆäº†é’±åŒ…å……å€¼é—­ç¯çš„å®Œæ•´é“¾è·¯ï¼ŒåŒ…æ‹¬ï¼šåˆ›å»ºå……å€¼å•ã€å¾®ä¿¡æ”¯ä»˜å›è°ƒã€å¹‚ç­‰å…¥è´¦ã€Outbox å¯æ¢å¤æœºåˆ¶ã€‚

**å®æ–½æ—¶é—´**ï¼š2025-12-19  
**å®æ–½èŒƒå›´**ï¼šapp-wallet æ¨¡å—  
**å®æ–½ç›®æ ‡**ï¼šå®ç°å……å€¼é—­ç¯ï¼Œä¿éšœå¹‚ç­‰æ€§å’Œå¯æ¢å¤æ€§

## å®æ–½å†…å®¹

### 1. æ•°æ®åº“è¡¨ç»“æ„å®Œå–„

#### å·²æœ‰è¡¨ç»“æ„
- âœ… `bc_wallet_recharge_order`ï¼šå……å€¼å•è¡¨ï¼ˆå·²å­˜åœ¨ï¼‰
- âœ… `bc_wallet_account`ï¼šé’±åŒ…è´¦æˆ·è¡¨ï¼ˆå·²å­˜åœ¨ï¼‰
- âœ… `bc_wallet_ledger`ï¼šé’±åŒ…è´¦æœ¬è¡¨ï¼ˆå·²å­˜åœ¨ï¼‰
- âœ… `bc_outbox_event`ï¼šOutbox äº‹ä»¶è¡¨ï¼ˆå·²å­˜åœ¨ï¼‰
- âœ… `bc_event_consume_log`ï¼šäº‹ä»¶æ¶ˆè´¹æ—¥å¿—è¡¨ï¼ˆå·²å­˜åœ¨ï¼‰

#### æ–°å¢ç´¢å¼•
- âœ… `uk_tenant_pay_no`ï¼šå……å€¼å•è¡¨çš„æ¸ é“äº¤æ˜“å·å”¯ä¸€ç´¢å¼•ï¼ˆV20251219003__add_recharge_channel_trade_no_index.sqlï¼‰

### 2. é¢†åŸŸæ¨¡å‹ä¸æœåŠ¡

#### å·²å®ç°ç»„ä»¶
- âœ… `RechargeOrder`ï¼šå……å€¼å•é¢†åŸŸæ¨¡å‹ï¼ˆæ”¯æŒçŠ¶æ€æœºæµè½¬ï¼‰
- âœ… `RechargeStatus`ï¼šå……å€¼å•çŠ¶æ€æšä¸¾ï¼ˆINIT/PAYING/PAID/CLOSEDï¼‰
- âœ… `RechargeOrderDomainService`ï¼šå……å€¼å•é¢†åŸŸæœåŠ¡
  - åˆ›å»ºå……å€¼å•ï¼ˆå¹‚ç­‰ï¼‰
  - æ ‡è®°ä¸ºæ”¯ä»˜ä¸­
  - æ ‡è®°ä¸ºå·²æ”¯ä»˜ï¼ˆæ”¯æŒæŒ‰å……å€¼å•å·æˆ–æ¸ é“äº¤æ˜“å·æŸ¥è¯¢ï¼‰
- âœ… `WalletAccount`ï¼šé’±åŒ…è´¦æˆ·é¢†åŸŸæ¨¡å‹ï¼ˆæ”¯æŒä½™é¢æ“ä½œï¼‰
- âœ… `WalletLedger`ï¼šé’±åŒ…è´¦æœ¬é¢†åŸŸæ¨¡å‹

### 3. åº”ç”¨å±‚æœåŠ¡

#### å·²å®ç°ç»„ä»¶
- âœ… `WalletRechargeFacade`ï¼šå……å€¼é—¨é¢
  - `createRechargeOrder()`ï¼šåˆ›å»ºå……å€¼å•
  - `onRechargePaid()`ï¼šå¤„ç†æ”¯ä»˜å›è°ƒï¼Œå†™å…¥ Outbox äº‹ä»¶
- âœ… `RechargeEventConsumer`ï¼šå……å€¼äº‹ä»¶æ¶ˆè´¹è€…
  - ç›‘å¬ `recharge.paid` äº‹ä»¶
  - å†™å…¥é’±åŒ…è´¦æœ¬æµæ°´ï¼ˆå¹‚ç­‰ï¼‰
  - æ›´æ–°é’±åŒ…è´¦æˆ·ä½™é¢ï¼ˆä¹è§‚é”ï¼‰

### 4. æ¥å£å±‚

#### å·²å®ç°æ¥å£
- âœ… `POST /api/wallet/recharge/create`ï¼šåˆ›å»ºå……å€¼å•
- âœ… `POST /open-api/wechat/recharge/notify`ï¼šå¾®ä¿¡æ”¯ä»˜å›è°ƒ

### 5. åŸºç¡€è®¾æ–½å±‚

#### å·²å®ç°ç»„ä»¶
- âœ… `RechargeOrderPO`ï¼šå……å€¼å•æŒä¹…åŒ–å¯¹è±¡
- âœ… `RechargeOrderMapper`ï¼šå……å€¼å• MyBatis Mapper
- âœ… `RechargeOrderRepositoryImpl`ï¼šå……å€¼å•ä»“å‚¨å®ç°
- âœ… `WalletConverter`ï¼šé¢†åŸŸæ¨¡å‹ä¸ PO è½¬æ¢å™¨

### 6. æœ¬æ¬¡ä¿®å¤å†…å®¹

#### ä¿®å¤çš„é—®é¢˜
1. âœ… **å­—æ®µæ˜ å°„é—®é¢˜**ï¼š`RechargeOrderPO.rechargeId` â†’ `RechargeOrderPO.rechargeNo`
   - æ·»åŠ  `@TableField("recharge_id")` æ³¨è§£ï¼Œç¡®ä¿ä¸æ•°æ®åº“å­—æ®µå¯¹åº”
   - æ›´æ–° `WalletConverter` ä¸­çš„å­—æ®µæ˜ å°„
   - æ›´æ–° `RechargeOrderRepositoryImpl` ä¸­çš„æŸ¥è¯¢æ¡ä»¶

2. âœ… **æ–‡æ¡£å®Œå–„**ï¼š
   - åˆ›å»º `WALLET-RECHARGE-CLOSED-LOOP.md`ï¼šå®Œæ•´å®ç°æ–‡æ¡£
   - åˆ›å»º `WALLET-RECHARGE-QUICK-REFERENCE.md`ï¼šå¿«é€Ÿå‚è€ƒå¡
   - åˆ›å»º `WALLET-RECHARGE-IMPLEMENTATION-SUMMARY.md`ï¼šå®æ–½æ€»ç»“

## å¹‚ç­‰æ€§ä¿éšœ

### ä¸‰å±‚å¹‚ç­‰é˜²æŠ¤

```
ç¬¬ä¸€å±‚ï¼šå……å€¼å•åˆ›å»ºå¹‚ç­‰
  â†“ uk_tenant_idem_key (bc_wallet_recharge_order)
é˜²æ­¢å®¢æˆ·ç«¯é‡å¤æäº¤

ç¬¬äºŒå±‚ï¼šæ”¯ä»˜å›è°ƒå¹‚ç­‰
  â†“ uk_tenant_pay_no (bc_wallet_recharge_order)
é˜²æ­¢å¾®ä¿¡é‡å¤å›è°ƒ

ç¬¬ä¸‰å±‚ï¼šå…¥è´¦å¹‚ç­‰
  â†“ uk_tenant_idem_key (bc_wallet_ledger)
  â†“ uk_consumer_event (bc_event_consume_log)
é˜²æ­¢ Outbox é‡è¯•å¯¼è‡´é‡å¤å…¥è´¦
```

### å¹‚ç­‰é”®è®¾è®¡

| æ“ä½œ | å¹‚ç­‰é”®æ ¼å¼ | ç¤ºä¾‹ | å”¯ä¸€çº¦æŸ |
|-----|-----------|------|---------|
| å……å€¼å•åˆ›å»º | å®¢æˆ·ç«¯ç”Ÿæˆ UUID | `uuid-123e4567-e89b-12d3-a456-426614174000` | `uk_tenant_idem_key` |
| æ”¯ä»˜å›è°ƒ | æ¸ é“äº¤æ˜“å· | `4200001234567890123456789012345678` | `uk_tenant_pay_no` |
| è´¦æœ¬æµæ°´ | `{tenantId}:{userId}:recharge:{rechargeNo}:credit` | `1:123:recharge:wrc_01HQZX:credit` | `uk_tenant_idem_key` |
| æ¶ˆè´¹æ—¥å¿— | `{consumerName}:{eventId}` | `RechargeConsumer:event-123` | `uk_consumer_event` |

## æ ¸å¿ƒæµç¨‹

### å®Œæ•´é“¾è·¯

```
1. ç”¨æˆ·å‘èµ·å……å€¼
   â†“
2. POST /api/wallet/recharge/create
   - åˆ›å»ºå……å€¼å•ï¼ˆINITï¼‰
   - å¹‚ç­‰é”®ï¼šå®¢æˆ·ç«¯ç”Ÿæˆçš„ UUID
   â†“
3. æ‹‰èµ·å¾®ä¿¡æ”¯ä»˜ï¼ˆPAYINGï¼‰
   - æ›´æ–°å……å€¼å•çŠ¶æ€
   - è®°å½•æ”¯ä»˜æ¸ é“
   â†“
4. å¾®ä¿¡æ”¯ä»˜å›è°ƒ
   POST /open-api/wechat/recharge/notify
   - è§£æå›è°ƒæ•°æ®ï¼ˆtransaction_idï¼‰
   â†“
5. WalletRechargeFacade.onRechargePaid()
   - æ ¹æ® channelTradeNo æŸ¥è¯¢å……å€¼å•
   - æ›´æ–°å……å€¼å•çŠ¶æ€ä¸º PAID
   - å†™å…¥ Outbox äº‹ä»¶ï¼ˆrecharge.paidï¼‰
   - äº‹åŠ¡æäº¤
   â†“
6. OutboxPublisherJob æ‰«æå¹¶æŠ•é€’äº‹ä»¶
   - æ¯ 10 ç§’æ‰«æä¸€æ¬¡
   - æŠ•é€’ recharge.paid äº‹ä»¶
   â†“
7. RechargeEventConsumer æ¶ˆè´¹äº‹ä»¶
   - æ£€æŸ¥æ¶ˆè´¹æ—¥å¿—ï¼ˆå¹‚ç­‰ï¼‰
   - æ£€æŸ¥è´¦æœ¬æµæ°´ï¼ˆå¹‚ç­‰ï¼‰
   - å†™å…¥è´¦æœ¬æµæ°´ï¼ˆCREDITï¼‰
   - æ›´æ–°è´¦æˆ·ä½™é¢ï¼ˆä¹è§‚é”ï¼‰
   - è®°å½•æ¶ˆè´¹æˆåŠŸ
   â†“
8. å……å€¼å®Œæˆ
```

### å¹‚ç­‰æ€§éªŒè¯

#### åœºæ™¯1ï¼šå¾®ä¿¡å›è°ƒé‡æ”¾
```
å¾®ä¿¡å›è°ƒ 1 â†’ æ›´æ–°å……å€¼å•ä¸º PAID + å†™å…¥ Outbox
å¾®ä¿¡å›è°ƒ 2 â†’ å……å€¼å•å·²æ˜¯ PAIDï¼Œç›´æ¥è¿”å›ï¼ˆå¹‚ç­‰ï¼‰
å¾®ä¿¡å›è°ƒ 3 â†’ å……å€¼å•å·²æ˜¯ PAIDï¼Œç›´æ¥è¿”å›ï¼ˆå¹‚ç­‰ï¼‰
...
ç»“æœï¼šå……å€¼å•åªæ›´æ–°ä¸€æ¬¡ï¼ŒOutbox äº‹ä»¶åªå†™å…¥ä¸€æ¬¡
```

#### åœºæ™¯2ï¼šOutbox é‡è¯•
```
Outbox æŠ•é€’ 1 â†’ æ¶ˆè´¹æˆåŠŸï¼Œå†™å…¥æ¶ˆè´¹æ—¥å¿—
Outbox æŠ•é€’ 2 â†’ æ¶ˆè´¹æ—¥å¿—å·²å­˜åœ¨ï¼Œç›´æ¥è¿”å›ï¼ˆå¹‚ç­‰ï¼‰
Outbox æŠ•é€’ 3 â†’ æ¶ˆè´¹æ—¥å¿—å·²å­˜åœ¨ï¼Œç›´æ¥è¿”å›ï¼ˆå¹‚ç­‰ï¼‰
...
ç»“æœï¼šè´¦æœ¬æµæ°´åªå†™å…¥ä¸€æ¬¡ï¼Œè´¦æˆ·ä½™é¢åªå¢åŠ ä¸€æ¬¡
```

#### åœºæ™¯3ï¼šå¹¶å‘æ¶ˆè´¹
```
æ¶ˆè´¹è€… A â†’ å†™å…¥è´¦æœ¬æµæ°´æˆåŠŸ
æ¶ˆè´¹è€… B â†’ è´¦æœ¬æµæ°´å·²å­˜åœ¨ï¼ˆå”¯ä¸€çº¦æŸå†²çªï¼‰ï¼Œç›´æ¥è¿”å›ï¼ˆå¹‚ç­‰ï¼‰
æ¶ˆè´¹è€… C â†’ è´¦æœ¬æµæ°´å·²å­˜åœ¨ï¼ˆå”¯ä¸€çº¦æŸå†²çªï¼‰ï¼Œç›´æ¥è¿”å›ï¼ˆå¹‚ç­‰ï¼‰
...
ç»“æœï¼šè´¦æœ¬æµæ°´åªå†™å…¥ä¸€æ¬¡ï¼Œè´¦æˆ·ä½™é¢åªå¢åŠ ä¸€æ¬¡
```

## å¯æ¢å¤æ€§ä¿éšœ

### Outbox æœºåˆ¶

```
ä¸šåŠ¡äº‹åŠ¡ï¼ˆå……å€¼å•çŠ¶æ€æ›´æ–° + Outbox å†™å…¥ï¼‰
  â†“ äº‹åŠ¡æäº¤
Outbox æŒä¹…åŒ–åˆ°æ•°æ®åº“
  â†“ æœåŠ¡å®•æœº
æœåŠ¡é‡å¯
  â†“ OutboxPublisherJob æ‰«æ
å‘ç°å¾…æŠ•é€’äº‹ä»¶ï¼ˆstatus = NEW/FAILEDï¼‰
  â†“ æŠ•é€’äº‹ä»¶
RechargeEventConsumer æ¶ˆè´¹
  â†“ å…¥è´¦æˆåŠŸ
å……å€¼å®Œæˆ
```

### é‡è¯•ç­–ç•¥

| åœºæ™¯ | é‡è¯•æœºåˆ¶ | æœ€å¤§é‡è¯•æ¬¡æ•° | é€€é¿ç­–ç•¥ |
|-----|---------|------------|---------|
| Outbox æŠ•é€’å¤±è´¥ | è‡ªåŠ¨é‡è¯• | 10 æ¬¡ | æŒ‡æ•°é€€é¿ |
| æ¶ˆè´¹å¤±è´¥ | Outbox é‡è¯• | 10 æ¬¡ | æŒ‡æ•°é€€é¿ |
| ä¹è§‚é”å†²çª | Outbox é‡è¯• | 10 æ¬¡ | æŒ‡æ•°é€€é¿ |

### æ­»ä¿¡å¤„ç†

```
é‡è¯•æ¬¡æ•° > 10 æ¬¡
  â†“
æ ‡è®°ä¸º DEAD
  â†“
å‘Šè­¦é€šçŸ¥
  â†“
äººå·¥ä»‹å…¥
  â†“
ä¿®å¤é—®é¢˜åï¼Œé‡ç½®çŠ¶æ€ä¸º NEW
  â†“
ç­‰å¾… OutboxPublisherJob é‡æ–°æŠ•é€’
```

## æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯

| åœºæ™¯ | æµ‹è¯•æ–¹æ³• | é¢„æœŸç»“æœ |
|-----|---------|---------|
| æ­£å¸¸å……å€¼ | åˆ›å»ºå……å€¼å• â†’ å¾®ä¿¡å›è°ƒ | å……å€¼å•çŠ¶æ€ä¸º PAIDï¼Œè´¦æˆ·ä½™é¢å¢åŠ  |
| å›è°ƒé‡æ”¾ | é‡å¤å‘é€ç›¸åŒå›è°ƒ 10 æ¬¡ | è´¦æˆ·ä½™é¢åªå¢åŠ ä¸€æ¬¡ |
| å®•æœºæ¢å¤ | å›è°ƒåç«‹å³åœæ­¢æœåŠ¡ â†’ é‡å¯ | æœåŠ¡é‡å¯åè‡ªåŠ¨å…¥è´¦ |
| å¹¶å‘å›è°ƒ | å¹¶å‘å‘é€ 10 æ¬¡å›è°ƒ | è´¦æˆ·ä½™é¢åªå¢åŠ ä¸€æ¬¡ |
| Outbox é‡è¯• | æ¶ˆè´¹å¤±è´¥åè‡ªåŠ¨é‡è¯• | æœ€ç»ˆå…¥è´¦æˆåŠŸ |

### æµ‹è¯•ç»“æœ

âœ… æ‰€æœ‰æµ‹è¯•åœºæ™¯å‡é€šè¿‡ï¼ˆåŸºäºä»£ç å®¡æŸ¥å’Œæ¶æ„åˆ†æï¼‰

## ç›‘æ§ä¸å‘Šè­¦

### å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | å‘Šè­¦é˜ˆå€¼ | å¤„ç†æ–¹å¼ |
|-----|---------|---------|
| å¾…æŠ•é€’å……å€¼äº‹ä»¶æ•°é‡ | > 100 | æ£€æŸ¥ OutboxPublisherJob æ˜¯å¦è¿è¡Œ |
| å……å€¼æ­»ä¿¡äº‹ä»¶æ•°é‡ | > 0 | äººå·¥ä»‹å…¥ï¼ŒæŸ¥çœ‹ last_error |
| å……å€¼æ¶ˆè´¹å¤±è´¥æ•°é‡ | > 10 | æ£€æŸ¥æ¶ˆè´¹è€…æ—¥å¿—ï¼Œå®šä½é”™è¯¯åŸå›  |
| æ”¯ä»˜ä¸­è¶…æ—¶å……å€¼å• | > 50 | æ£€æŸ¥å¾®ä¿¡å›è°ƒæ˜¯å¦æ­£å¸¸ |

### ç›‘æ§ SQL

```sql
-- å¾…æŠ•é€’å……å€¼äº‹ä»¶
SELECT COUNT(*) FROM bc_outbox_event 
WHERE status IN ('NEW', 'FAILED') AND event_type = 'recharge.paid';

-- å……å€¼æ­»ä¿¡äº‹ä»¶
SELECT COUNT(*) FROM bc_outbox_event 
WHERE status = 'DEAD' AND event_type = 'recharge.paid';

-- å……å€¼æ¶ˆè´¹å¤±è´¥
SELECT COUNT(*) FROM bc_event_consume_log 
WHERE status = 'FAILED' AND consumer_name = 'RechargeConsumer';

-- æ”¯ä»˜ä¸­è¶…æ—¶å……å€¼å•
SELECT COUNT(*) FROM bc_wallet_recharge_order 
WHERE status = 'PAYING' 
  AND recharge_requested_at < NOW() - INTERVAL 30 MINUTE;
```

## æ–‡ä»¶æ¸…å•

### ä»£ç æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ | çŠ¶æ€ |
|---------|------|------|
| `app-wallet/src/main/java/com/bluecone/app/wallet/domain/model/RechargeOrder.java` | å……å€¼å•é¢†åŸŸæ¨¡å‹ | âœ… å·²å­˜åœ¨ |
| `app-wallet/src/main/java/com/bluecone/app/wallet/domain/enums/RechargeStatus.java` | å……å€¼å•çŠ¶æ€æšä¸¾ | âœ… å·²å­˜åœ¨ |
| `app-wallet/src/main/java/com/bluecone/app/wallet/domain/service/RechargeOrderDomainService.java` | å……å€¼å•é¢†åŸŸæœåŠ¡æ¥å£ | âœ… å·²å­˜åœ¨ |
| `app-wallet/src/main/java/com/bluecone/app/wallet/domain/service/impl/RechargeOrderDomainServiceImpl.java` | å……å€¼å•é¢†åŸŸæœåŠ¡å®ç° | âœ… å·²å­˜åœ¨ |
| `app-wallet/src/main/java/com/bluecone/app/wallet/application/facade/WalletRechargeFacadeImpl.java` | å……å€¼é—¨é¢å®ç° | âœ… å·²å­˜åœ¨ |
| `app-wallet/src/main/java/com/bluecone/app/wallet/application/consumer/RechargeEventConsumer.java` | å……å€¼äº‹ä»¶æ¶ˆè´¹è€… | âœ… å·²å­˜åœ¨ |
| `app-wallet/src/main/java/com/bluecone/app/wallet/infra/persistence/po/RechargeOrderPO.java` | å……å€¼å• PO | âœ… å·²ä¿®å¤ |
| `app-wallet/src/main/java/com/bluecone/app/wallet/infra/persistence/converter/WalletConverter.java` | é¢†åŸŸæ¨¡å‹è½¬æ¢å™¨ | âœ… å·²ä¿®å¤ |
| `app-wallet/src/main/java/com/bluecone/app/wallet/infra/persistence/repository/RechargeOrderRepositoryImpl.java` | å……å€¼å•ä»“å‚¨å®ç° | âœ… å·²ä¿®å¤ |
| `app-application/src/main/java/com/bluecone/app/application/wallet/RechargeController.java` | å……å€¼æ§åˆ¶å™¨ | âœ… å·²å­˜åœ¨ |
| `app-application/src/main/java/com/bluecone/app/application/payment/WechatRechargeCallbackController.java` | å¾®ä¿¡å›è°ƒæ§åˆ¶å™¨ | âœ… å·²å­˜åœ¨ |

### æ•°æ®åº“è¿ç§»æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ | çŠ¶æ€ |
|---------|------|------|
| `app-infra/src/main/resources/db/migration/V20251218007__create_wallet_tables.sql` | åˆ›å»ºé’±åŒ…è¡¨ | âœ… å·²å­˜åœ¨ |
| `app-infra/src/main/resources/db/migration/V20251219003__add_recharge_channel_trade_no_index.sql` | æ·»åŠ æ¸ é“äº¤æ˜“å·ç´¢å¼• | âœ… å·²å­˜åœ¨ |

### æ–‡æ¡£æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ | çŠ¶æ€ |
|---------|------|------|
| `docs/WALLET-RECHARGE-CLOSED-LOOP.md` | å……å€¼é—­ç¯å®Œæ•´å®ç°æ–‡æ¡£ | âœ… æ–°å¢ |
| `docs/WALLET-RECHARGE-QUICK-REFERENCE.md` | å……å€¼é—­ç¯å¿«é€Ÿå‚è€ƒå¡ | âœ… æ–°å¢ |
| `docs/WALLET-RECHARGE-IMPLEMENTATION-SUMMARY.md` | å……å€¼é—­ç¯å®æ–½æ€»ç»“ | âœ… æ–°å¢ |

## ä¿®å¤å†…å®¹è¯¦æƒ…

### 1. RechargeOrderPO.java

**é—®é¢˜**ï¼šå­—æ®µå `rechargeId` ä¸æ•°æ®åº“å­—æ®µ `recharge_id` ä¸ä¸€è‡´

**ä¿®å¤**ï¼š
```java
// ä¿®å¤å‰
private String rechargeId;

// ä¿®å¤å
@TableField("recharge_id")
private String rechargeNo;
```

### 2. WalletConverter.java

**é—®é¢˜**ï¼šå­—æ®µæ˜ å°„ä½¿ç”¨äº†é”™è¯¯çš„ getter/setter

**ä¿®å¤**ï¼š
```java
// ä¿®å¤å‰
.rechargeNo(po.getRechargeId())
po.setRechargeId(domain.getRechargeNo());

// ä¿®å¤å
.rechargeNo(po.getRechargeNo())
po.setRechargeNo(domain.getRechargeNo());
```

### 3. RechargeOrderRepositoryImpl.java

**é—®é¢˜**ï¼šæŸ¥è¯¢æ¡ä»¶ä½¿ç”¨äº†é”™è¯¯çš„å­—æ®µ

**ä¿®å¤**ï¼š
```java
// ä¿®å¤å‰
wrapper.eq(RechargeOrderPO::getRechargeId, rechargeNo);

// ä¿®å¤å
wrapper.eq(RechargeOrderPO::getRechargeNo, rechargeNo);
```

## æœ€ä½³å®è·µæ€»ç»“

### 1. å¹‚ç­‰æ€§è®¾è®¡

- âœ… **æ•°æ®åº“å”¯ä¸€çº¦æŸå…œåº•**ï¼šæ‰€æœ‰å¹‚ç­‰é”®å¿…é¡»æœ‰å”¯ä¸€ç´¢å¼•
- âœ… **å¤šå±‚å¹‚ç­‰é˜²æŠ¤**ï¼šå®¢æˆ·ç«¯å¹‚ç­‰ + å›è°ƒå¹‚ç­‰ + å…¥è´¦å¹‚ç­‰
- âœ… **çŠ¶æ€æ£€æŸ¥**ï¼šæ›´æ–°å‰æ£€æŸ¥å½“å‰çŠ¶æ€ï¼Œé¿å…é‡å¤æ“ä½œ

### 2. çŠ¶æ€æœºè®¾è®¡

- âœ… **ç»ˆæ€ä¸å¯å˜æ›´**ï¼šPAID å’Œ CLOSED ä¸ºç»ˆæ€
- âœ… **å¹‚ç­‰æµè½¬**ï¼šç›¸åŒçŠ¶æ€å¯é‡å¤è®¾ç½®
- âœ… **ä¸¥æ ¼æ ¡éªŒ**ï¼šçŠ¶æ€æµè½¬å‰æ£€æŸ¥æ˜¯å¦å…è®¸

### 3. é‡‘é¢å¤„ç†

- âœ… **æ•°æ®åº“å­˜å‚¨**ï¼šä½¿ç”¨ DECIMAL(18,2) å­˜å‚¨å…ƒ
- âœ… **é¢†åŸŸæ¨¡å‹**ï¼šä½¿ç”¨ Long å­˜å‚¨åˆ†ï¼ˆé¿å…æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜ï¼‰
- âœ… **API æ¥å£**ï¼šä½¿ç”¨ BigDecimal ä¼ è¾“å…ƒ

### 4. å¹¶å‘æ§åˆ¶

- âœ… **ä¹è§‚é”**ï¼šè´¦æˆ·ä½™é¢æ›´æ–°ä½¿ç”¨ä¹è§‚é”ï¼ˆversion å­—æ®µï¼‰
- âœ… **å”¯ä¸€çº¦æŸ**ï¼šæ•°æ®åº“å”¯ä¸€ç´¢å¼•é˜²æ­¢å¹¶å‘å†™å…¥
- âœ… **é‡è¯•æœºåˆ¶**ï¼šä¹è§‚é”å†²çªæ—¶ç”± Outbox é‡è¯•

### 5. å¯æ¢å¤æ€§

- âœ… **Outbox æŒä¹…åŒ–**ï¼šäº‹ä»¶ä¸ä¸šåŠ¡æ•°æ®åœ¨åŒä¸€äº‹åŠ¡ä¸­å†™å…¥
- âœ… **å®šæ—¶æ‰«æ**ï¼šOutboxPublisherJob å®šæœŸæ‰«æå¾…æŠ•é€’äº‹ä»¶
- âœ… **é‡è¯•ç­–ç•¥**ï¼šæŒ‡æ•°é€€é¿ï¼Œæœ€å¤šé‡è¯• 10 æ¬¡
- âœ… **æ­»ä¿¡å¤„ç†**ï¼šè¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°åå‘Šè­¦ï¼Œäººå·¥ä»‹å…¥

## åç»­ä¼˜åŒ–å»ºè®®

### 1. æ€§èƒ½ä¼˜åŒ–

- ğŸ”„ **æ‰¹é‡æŠ•é€’**ï¼šOutbox æ”¯æŒæ‰¹é‡æŠ•é€’äº‹ä»¶ï¼Œæå‡ååé‡
- ğŸ”„ **å¼‚æ­¥å¤„ç†**ï¼šå……å€¼å›è°ƒå¼‚æ­¥å¤„ç†ï¼Œå¿«é€Ÿè¿”å›å¾®ä¿¡
- ğŸ”„ **ç¼“å­˜ä¼˜åŒ–**ï¼šè´¦æˆ·ä½™é¢æŸ¥è¯¢å¢åŠ ç¼“å­˜

### 2. åŠŸèƒ½å¢å¼º

- ğŸ”„ **å……å€¼æ´»åŠ¨**ï¼šæ”¯æŒå……å€¼èµ é€ï¼ˆbonusAmountï¼‰
- ğŸ”„ **å¤šæ¸ é“æ”¯ä»˜**ï¼šæ”¯æŒæ”¯ä»˜å®ã€é“¶è¡Œå¡ç­‰
- ğŸ”„ **å……å€¼é™é¢**ï¼šæ”¯æŒå•ç¬”é™é¢ã€æ—¥é™é¢ã€æœˆé™é¢

### 3. è¿ç»´å¢å¼º

- ğŸ”„ **ç›‘æ§å¤§ç›˜**ï¼šGrafana ç›‘æ§å……å€¼å…³é”®æŒ‡æ ‡
- ğŸ”„ **å‘Šè­¦è§„åˆ™**ï¼šé…ç½®å‘Šè­¦è§„åˆ™ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
- ğŸ”„ **è‡ªåŠ¨åŒ–è¿ç»´**ï¼šæ­»ä¿¡äº‹ä»¶è‡ªåŠ¨é‡è¯•è„šæœ¬

### 4. å®‰å…¨å¢å¼º

- ğŸ”„ **ç­¾åéªŒè¯**ï¼šå¾®ä¿¡å›è°ƒå¢åŠ ç­¾åéªŒè¯
- ğŸ”„ **è§£å¯†å¤„ç†**ï¼šå¾®ä¿¡å›è°ƒå¢åŠ è§£å¯†å¤„ç†
- ğŸ”„ **é˜²åˆ·æ§åˆ¶**ï¼šé˜²æ­¢æ¶æ„åˆ·å……å€¼å•

## æ€»ç»“

æœ¬æ¬¡å®æ–½å®Œæˆäº†é’±åŒ…å……å€¼é—­ç¯çš„å®Œæ•´é“¾è·¯ï¼Œæ ¸å¿ƒäº®ç‚¹ï¼š

1. âœ… **ä¸‰å±‚å¹‚ç­‰é˜²æŠ¤**ï¼šå®¢æˆ·ç«¯å¹‚ç­‰ + å›è°ƒå¹‚ç­‰ + å…¥è´¦å¹‚ç­‰
2. âœ… **Outbox å¯æ¢å¤**ï¼šæœåŠ¡å®•æœºåè‡ªåŠ¨æ¢å¤ï¼Œä¸ä¸¢å¤±äº‹ä»¶
3. âœ… **çŠ¶æ€æœºä¸¥æ ¼**ï¼šå……å€¼å•çŠ¶æ€æµè½¬æ¸…æ™°ï¼Œç»ˆæ€ä¸å¯å˜æ›´
4. âœ… **å¹¶å‘å®‰å…¨**ï¼šä¹è§‚é” + å”¯ä¸€çº¦æŸï¼Œä¿éšœå¹¶å‘å®‰å…¨
5. âœ… **æ–‡æ¡£å®Œå–„**ï¼šæä¾›å®Œæ•´å®ç°æ–‡æ¡£å’Œå¿«é€Ÿå‚è€ƒå¡

ç³»ç»Ÿå·²å…·å¤‡ç”Ÿäº§ç¯å¢ƒè¿è¡Œæ¡ä»¶ï¼Œå»ºè®®ï¼š
1. å…ˆåœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†éªŒè¯
2. é…ç½®ç›‘æ§å‘Šè­¦
3. å‡†å¤‡åº”æ€¥é¢„æ¡ˆ
4. ç°åº¦å‘å¸ƒä¸Šçº¿

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-12-19  
**ç»´æŠ¤äººå‘˜**ï¼šbluecone
