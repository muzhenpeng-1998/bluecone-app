# 商户后台 C3（最小控制台）实现说明

## 概述

本文档描述商户后台 MVP 的实现方案，包含门店/商品/订单/优惠券/储值/概览 6 个功能域的后台接口，并具备 RBAC、租户隔离与审计日志能力。

## 一、架构设计

### 1.1 模块划分

```
bluecone-app/
├── app-security/              # 安全模块（RBAC权限）
│   └── admin/
│       ├── RequireAdminPermission.java    # 权限注解
│       └── AdminPermissionAspect.java     # 权限AOP拦截器
├── app-infra/                 # 基础设施模块
│   └── admin/
│       ├── entity/            # RBAC实体（角色、权限、用户角色、角色权限、审计日志）
│       ├── mapper/            # MyBatis Mapper
│       └── service/           # RBAC服务（AdminAuthorizationService、AuditLogService）
└── app-application/           # 应用层
    └── controller/admin/      # 后台控制器
        ├── StoreAdminController.java          # 门店管理
        ├── ProductAdminController.java        # 商品管理
        ├── OrderAdminController.java          # 订单管理
        ├── CouponTemplateAdminController.java # 优惠券管理
        ├── CouponGrantAdminController.java    # 发券管理
        ├── WalletAdminController.java         # 钱包管理
        └── DashboardAdminController.java      # 概览仪表盘
```

### 1.2 技术栈

- **权限控制**: 自定义注解 + Spring AOP
- **租户隔离**: TenantContext（ThreadLocal）+ MyBatis-Plus 租户拦截器
- **审计日志**: 异步写入 + JSON 快照
- **数据访问**: MyBatis-Plus + 领域仓储模式

## 二、RBAC 权限体系

### 2.1 数据库设计

#### 表结构

1. **bc_admin_role** - 角色表
   - 支持系统预置角色和自定义角色
   - 租户隔离（tenant_id）

2. **bc_admin_permission** - 权限表
   - 权限格式：`{resource}:{action}`（如：`product:edit`）
   - 支持权限树（parent_id）

3. **bc_admin_user_role** - 用户角色关联表
   - 支持作用域（scope_type, scope_id）
   - 支持有效期（valid_from, valid_until）

4. **bc_admin_role_permission** - 角色权限关联表
   - 多对多关系
   - 租户隔离

#### 预置角色

| 角色代码 | 角色名称 | 权限范围 |
|---------|---------|---------|
| SUPER_ADMIN | 超级管理员 | 所有权限 |
| STORE_ADMIN | 门店管理员 | 门店所有功能权限（除系统管理） |
| STORE_MANAGER | 门店经理 | 查看数据 + 管理订单 |
| CASHIER | 收银员 | 仅查看订单和商品 |

#### 预置权限

| 权限代码 | 权限名称 | 资源类型 | 操作类型 |
|---------|---------|---------|---------|
| store:view | 查看门店 | STORE | VIEW |
| store:edit | 编辑门店 | STORE | EDIT |
| product:view | 查看商品 | PRODUCT | VIEW |
| product:create | 创建商品 | PRODUCT | CREATE |
| product:edit | 编辑商品 | PRODUCT | EDIT |
| product:online | 商品上下线 | PRODUCT | MANAGE |
| order:view | 查看订单 | ORDER | VIEW |
| order:manage | 管理订单 | ORDER | MANAGE |
| coupon:view | 查看优惠券 | COUPON | VIEW |
| coupon:create | 创建优惠券 | COUPON | CREATE |
| coupon:edit | 编辑优惠券 | COUPON | EDIT |
| coupon:online | 优惠券上下线 | COUPON | MANAGE |
| coupon:grant | 发放优惠券 | COUPON | GRANT |
| wallet:view | 查看钱包 | WALLET | VIEW |
| dashboard:view | 查看仪表盘 | DASHBOARD | VIEW |

### 2.2 权限校验流程

```
1. 请求进入 → AdminPermissionAspect 拦截
2. 从 SecurityContext 获取 userId
3. 从 TenantContext 获取 tenantId
4. 调用 AdminAuthorizationService.hasPermission()
5. 查询用户角色 → 查询角色权限 → 校验权限
6. 权限通过 → 执行业务逻辑
7. 权限不足 → 抛出 AccessDeniedException（403）
```

### 2.3 使用示例

```java
@GetMapping("/{id}")
@RequireAdminPermission("product:view")
public ProductDetailView getProduct(@RequestHeader("X-Tenant-Id") Long tenantId,
                                   @PathVariable Long id) {
    // 业务逻辑
}

// 多个权限（AND关系）
@PutMapping("/{id}")
@RequireAdminPermission(value = {"product:edit", "product:online"}, requireAll = true)
public void updateAndPublish(...) {
    // 业务逻辑
}

// 多个权限（OR关系）
@GetMapping
@RequireAdminPermission(value = {"product:view", "product:edit"}, requireAll = false)
public List<Product> listProducts(...) {
    // 业务逻辑
}
```

## 三、租户隔离

### 3.1 隔离策略

**强制租户隔离**：所有后台接口必须从鉴权上下文注入 `tenantId`，不允许前端任意传递。

### 3.2 实现方式

1. **请求头注入**
   ```java
   @GetMapping("/{id}")
   public StoreBaseView getStore(@RequestHeader("X-Tenant-Id") Long tenantId,
                                 @PathVariable Long id) {
       // tenantId 从请求头注入，由认证中间件填充
   }
   ```

2. **数据库查询校验**
   ```java
   // 查询时必须带上 tenantId
   BcStore store = storeMapper.selectOne(new LambdaQueryWrapper<BcStore>()
           .eq(BcStore::getTenantId, tenantId)
           .eq(BcStore::getId, id)
           .eq(BcStore::getIsDeleted, false));
   
   if (store == null) {
       throw new IllegalArgumentException("门店不存在或无权访问");
   }
   ```

3. **MyBatis-Plus 租户拦截器**
   - 自动在 SQL 中添加 `tenant_id` 条件
   - 配置在 `MybatisPlusConfig.java`

### 3.3 安全保障

- ✅ 所有查询必须带 `tenant_id` 条件
- ✅ 所有写操作必须校验资源归属
- ✅ 跨租户访问返回 403 或 404
- ✅ 审计日志记录租户信息

## 四、审计日志

### 4.1 审计表设计

**bc_admin_audit_log** 包含以下字段：

- 操作人信息：operator_id, operator_name, operator_ip
- 操作信息：action, resource_type, resource_id, resource_name
- 数据快照：data_before, data_after, change_summary（JSON格式）
- 操作结果：status, error_message
- 请求上下文：request_uri, request_method, trace_id, user_agent

### 4.2 记录时机

**必须记录审计日志的操作**：

- ✅ 商品改价
- ✅ 商品上下线
- ✅ 优惠券模板上下线
- ✅ 门店信息修改
- ✅ 优惠券发放
- ✅ 所有写操作（CREATE、UPDATE、DELETE）

### 4.3 使用示例

```java
// 记录审计日志
Long operatorId = getCurrentUserId();
auditLogService.log(auditLogService.builder(tenantId, operatorId)
        .action("UPDATE")
        .resourceType("PRODUCT")
        .resourceId(productId)
        .resourceName(product.getName())
        .operationDesc("修改商品信息")
        .dataBefore(productBefore)  // 操作前快照
        .dataAfter(productAfter));  // 操作后快照
```

### 4.4 特性

- ✅ 异步写入（不阻塞业务）
- ✅ 自动提取请求上下文（IP、URI、User-Agent）
- ✅ JSON 格式存储数据快照
- ✅ 支持变更摘要（change_summary）

## 五、API 接口清单

### 5.1 门店管理

| 接口 | 方法 | 路径 | 权限 | 说明 |
|-----|------|------|------|------|
| 查询门店详情 | GET | /api/admin/stores/{id} | store:view | 查看门店基本信息 |
| 更新门店信息 | PUT | /api/admin/stores/{id} | store:edit | 修改门店名称、地址、联系方式等 |
| 更新营业时间 | PUT | /api/admin/stores/{id}/opening-hours | store:edit | 修改门店营业时间 |

### 5.2 商品管理

| 接口 | 方法 | 路径 | 权限 | 说明 |
|-----|------|------|------|------|
| 分页查询商品 | GET | /api/admin/products | product:view | 支持名称搜索、状态筛选 |
| 查询商品详情 | GET | /api/admin/products/{id} | product:view | 含SKU列表 |
| 创建商品 | POST | /api/admin/products | product:create | 创建商品及SKU |
| 更新商品信息 | PUT | /api/admin/products/{id} | product:edit | 修改商品信息 |
| 商品上线 | POST | /api/admin/products/{id}/online | product:online | 商品上线 |
| 商品下线 | POST | /api/admin/products/{id}/offline | product:online | 商品下线 |

### 5.3 订单管理

| 接口 | 方法 | 路径 | 权限 | 说明 |
|-----|------|------|------|------|
| 分页查询订单 | GET | /api/admin/orders | order:view | 支持状态、时间、门店筛选 |
| 查询订单详情 | GET | /api/admin/orders/{id} | order:view | 含明细、支付信息、forensics链接 |
| 查询订单诊断 | GET | /api/admin/orders/{id}/forensics | order:view | 聚合全链路诊断数据 |

### 5.4 优惠券管理

| 接口 | 方法 | 路径 | 权限 | 说明 |
|-----|------|------|------|------|
| 查询模板列表 | GET | /api/admin/promo/templates | coupon:view | 支持状态筛选 |
| 查询模板详情 | GET | /api/admin/promo/templates/{id} | coupon:view | 模板详细信息 |
| 创建模板 | POST | /api/admin/promo/templates | coupon:create | 创建优惠券模板 |
| 更新模板 | PUT | /api/admin/promo/templates/{id} | coupon:edit | 修改模板信息 |
| 模板上线 | POST | /api/admin/promo/templates/{id}/publish | coupon:online | 模板上线 |
| 模板下线 | POST | /api/admin/promo/templates/{id}/offline | coupon:online | 模板下线 |
| 手动发券 | POST | /api/admin/promo/grants | coupon:grant | 支持单用户或批量发券 |
| 查询发券记录 | GET | /api/admin/promo/grants/user/{userId} | coupon:view | 按用户查询 |
| 查询发券记录 | GET | /api/admin/promo/grants/template/{templateId} | coupon:view | 按模板查询 |

### 5.5 钱包管理

| 接口 | 方法 | 路径 | 权限 | 说明 |
|-----|------|------|------|------|
| 查询用户余额 | GET | /api/admin/wallet/balances | wallet:view | 支持按用户筛选 |
| 查询充值记录 | GET | /api/admin/wallet/recharges | wallet:view | 支持按用户、状态筛选 |
| 查询流水记录 | GET | /api/admin/wallet/ledgers | wallet:view | 按用户查询流水 |

### 5.6 概览仪表盘

| 接口 | 方法 | 路径 | 权限 | 说明 |
|-----|------|------|------|------|
| 查询经营概览 | GET | /api/admin/dashboard/summary | dashboard:view | 今日订单数、GMV、券核销、余额支付等KPI |

## 六、测试要点

### 6.1 权限测试

```bash
# 测试1：无权限访问（应返回 403）
curl -X GET http://localhost:8080/api/admin/products \
  -H "X-Tenant-Id: 1" \
  -H "Authorization: Bearer <无权限token>"

# 测试2：有权限访问（应返回 200）
curl -X GET http://localhost:8080/api/admin/products \
  -H "X-Tenant-Id: 1" \
  -H "Authorization: Bearer <有权限token>"
```

### 6.2 租户隔离测试

```bash
# 测试1：访问自己租户的资源（应返回 200）
curl -X GET http://localhost:8080/api/admin/stores/1 \
  -H "X-Tenant-Id: 1" \
  -H "Authorization: Bearer <token>"

# 测试2：访问其他租户的资源（应返回 404 或 403）
curl -X GET http://localhost:8080/api/admin/stores/999 \
  -H "X-Tenant-Id: 1" \
  -H "Authorization: Bearer <token>"
```

### 6.3 审计日志测试

```sql
-- 执行写操作后，查询审计日志
SELECT * FROM bc_admin_audit_log 
WHERE tenant_id = 1 
  AND resource_type = 'PRODUCT' 
  AND resource_id = 123
ORDER BY created_at DESC;

-- 验证审计日志包含：
-- 1. operator_id, operator_name
-- 2. action, resource_type, resource_id
-- 3. data_before, data_after (JSON格式)
-- 4. request_uri, operator_ip
```

## 七、部署说明

### 7.1 数据库迁移

```bash
# Flyway 会自动执行以下迁移脚本：
# V20251219005__create_admin_rbac_tables.sql
# V20251219006__create_admin_audit_log_table.sql
```

### 7.2 初始化数据

迁移脚本会自动初始化：
- 系统预置权限（15个）
- 系统预置角色（4个）
- 角色权限关联

### 7.3 配置要求

```yaml
# application.yml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/bluecone?useSSL=false
    username: root
    password: password
  
mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  
# 启用异步审计日志
spring:
  task:
    execution:
      pool:
        core-size: 2
        max-size: 5
```

## 八、最佳实践

### 8.1 权限设计

- ✅ 权限粒度适中（不要过细或过粗）
- ✅ 使用语义化的权限代码（`resource:action`）
- ✅ 支持权限组合（AND/OR）
- ✅ 定期审查权限分配

### 8.2 租户隔离

- ✅ 所有查询必须带 `tenant_id`
- ✅ 所有写操作必须校验归属
- ✅ 使用 MyBatis-Plus 租户拦截器
- ✅ 避免硬编码租户ID

### 8.3 审计日志

- ✅ 记录关键操作（写操作、状态变更）
- ✅ 使用异步写入（不阻塞业务）
- ✅ 保留足够的上下文信息
- ✅ 定期归档历史日志

### 8.4 性能优化

- ✅ 权限查询使用缓存（5分钟）
- ✅ 审计日志异步写入
- ✅ 分页查询避免全表扫描
- ✅ 合理使用索引

## 九、常见问题

### Q1: 如何为新租户初始化角色权限？

```sql
-- 从模板复制角色和权限
INSERT INTO bc_admin_role (tenant_id, role_code, role_name, role_type, description)
SELECT {new_tenant_id}, role_code, role_name, 'CUSTOM', description
FROM bc_admin_role
WHERE tenant_id = 0;  -- 0 为系统模板

-- 复制角色权限关联
INSERT INTO bc_admin_role_permission (tenant_id, role_id, permission_id)
SELECT {new_tenant_id}, new_role.id, rp.permission_id
FROM bc_admin_role_permission rp
INNER JOIN bc_admin_role old_role ON rp.role_id = old_role.id
INNER JOIN bc_admin_role new_role ON new_role.role_code = old_role.role_code
WHERE rp.tenant_id = 0 AND new_role.tenant_id = {new_tenant_id};
```

### Q2: 如何清除权限缓存？

```java
// 方式1：通过 CacheManager
@Autowired
private CacheManager cacheManager;

public void clearUserPermissionsCache(Long tenantId, Long userId) {
    Cache cache = cacheManager.getCache("admin:permissions");
    if (cache != null) {
        cache.evict(tenantId + ":" + userId);
    }
}

// 方式2：使用 @CacheEvict 注解
@CacheEvict(value = "admin:permissions", key = "#tenantId + ':' + #userId")
public void updateUserRoles(Long tenantId, Long userId, List<Long> roleIds) {
    // 更新用户角色
}
```

### Q3: 如何查看用户的所有权限？

```sql
-- 查询用户的所有权限
SELECT DISTINCT p.permission_code, p.permission_name, p.resource_type, p.action
FROM bc_admin_user_role ur
INNER JOIN bc_admin_role_permission rp ON ur.role_id = rp.role_id
INNER JOIN bc_admin_permission p ON rp.permission_id = p.id
WHERE ur.tenant_id = {tenant_id} 
  AND ur.user_id = {user_id}
  AND ur.status = 'ACTIVE'
  AND rp.status = 'ACTIVE'
  AND p.status = 'ACTIVE';
```

## 十、后续优化方向

1. **权限管理界面**：提供可视化的角色权限配置界面
2. **审计日志查询**：提供审计日志查询和导出功能
3. **数据权限**：支持更细粒度的数据权限（如：只能查看自己门店的订单）
4. **操作审批**：关键操作需要审批流程
5. **性能监控**：监控接口性能和权限校验耗时
6. **安全加固**：IP白名单、操作频率限制、敏感操作二次验证

---

**文档版本**: v1.0  
**最后更新**: 2025-12-19  
**维护人**: BlueCone Architecture Team
