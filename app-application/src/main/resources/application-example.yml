# BlueCone Application - 配置示例模板
# 
# 说明：
# 1. 此文件为配置结构示例，所有敏感信息已脱敏
# 2. 本地开发请复制此文件为 application-local.yml（已加入 .gitignore）
# 3. 生产环境请使用环境变量注入敏感配置

server:
  port: 80

spring:
  application:
    name: bluecone-app
  flyway:
    # Flyway 迁移校验：开启后会在迁移前校验脚本完整性，确保可重复、可校验
    validate-on-migrate: true

  datasource:
    # 数据库连接：请通过环境变量 DB_URL 注入，或使用 application-local.yml
    url: ${DB_URL:jdbc:mysql://localhost:3306/bluecone?useSSL=false&serverTimezone=Asia/Shanghai&characterEncoding=utf8}
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD:}
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      maximum-pool-size: 10
      minimum-idle: 2
      idle-timeout: 600000
      max-lifetime: 1800000
      connection-timeout: 30000

  data:
    redis:
      # Redis 连接：请通过环境变量注入
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      database: ${REDIS_DATABASE:0}
      username: ${REDIS_USERNAME:}
      password: ${REDIS_PASSWORD:}

mybatis-plus:
  enabled: true

bluecone:
  cache:
    l1:
      max-size: 20000
    l2:
      enabled: true
    consistency:
      redis:
        enabled: true
    profiles:
      user-profile:
        ttl-seconds: 600
        cache-null: true
      order-detail:
        ttl-seconds: 180
        strong-consistency: true
      tenant-config:
        ttl-seconds: 1800
        cache-null: false

  outbox:
    enabled: true
    publish-cron: "0/5 * * * * ?"    # 调试时 5 秒扫描一次
    clean-cron: "0 0 3 * * ?"        # 每日 3 点清理 DONE/DEAD
    max-retries: 5
    base-delay-seconds: 1
    max-delay-seconds: 300
    backoff-multiplier: 2.0
    dispatch-batch-size: 100
    clean-retention-days: 7
    consumption-dedup-days: 7

  storage:
    provider: ALIYUN_OSS
    aliyun:
      # OSS 配置：请通过环境变量注入访问密钥
      endpoint: ${OSS_ENDPOINT:https://oss-cn-hangzhou.aliyuncs.com}
      access-key-id: ${OSS_ACCESS_KEY_ID:}
      access-key-secret: ${OSS_ACCESS_KEY_SECRET:}
      default-bucket: ${OSS_BUCKET:bluecone}
      default-expire-seconds: 600
      cdn-domain: ${OSS_CDN_DOMAIN:https://cdn.bluecone.com}
      public-domain: ${OSS_PUBLIC_DOMAIN:https://img.bluecone.com}

  resource:
    quota:
      default-daily-upload-count-limit: 2000
      default-daily-upload-bytes-limit: 10737418240
      tenant-overrides:
        1001:
          daily-upload-count-limit: 10000
          daily-upload-bytes-limit: 53687091200
        1002:
          daily-upload-count-limit: 500
          daily-upload-bytes-limit: 1073741824

  log:
    enabled: false

  id:
    long:
      enabled: true
      node-id: 1

# 微信开放平台配置
wechat:
  open-platform:
    # 是否启用微信开放平台功能（本地开发可设为 false 使用 Stub）
    enabled: ${WECHAT_OPEN_PLATFORM_ENABLED:true}
    # 第三方平台 appid（从微信开放平台获取）
    component-app-id: ${WECHAT_COMPONENT_APP_ID:}
    # 第三方平台 appsecret（从微信开放平台获取）
    component-app-secret: ${WECHAT_COMPONENT_APP_SECRET:}
    # 消息校验 Token（在微信开放平台配置，用于验证消息来源）
    component-token: ${WECHAT_COMPONENT_TOKEN:}
    # 消息加解密 Key（在微信开放平台配置，43位字符，用于消息加解密）
    component-aes-key: ${WECHAT_COMPONENT_AES_KEY:}
  
  # 微信支付服务商模式配置
  pay:
    partner:
      # 是否启用微信支付服务商模式（本地开发可设为 false）
      enabled: ${WECHAT_PAY_PARTNER_ENABLED:false}
      # 服务商应用 AppID（sp_appid）
      # 获取方式：登录微信支付商户平台 > 产品中心 > 开发配置 > 服务商 AppID
      sp-app-id: ${WECHAT_PAY_SP_APP_ID:}
      # 服务商商户号（sp_mchid）
      # 获取方式：登录微信支付商户平台 > 账户中心 > 商户信息 > 商户号
      sp-mch-id: ${WECHAT_PAY_SP_MCH_ID:}
      # 微信支付 V3 API 密钥（32位，用于回调解密）
      # 获取方式：登录微信支付商户平台 > 账户中心 > API安全 > 设置APIv3密钥
      # 注意：APIv3密钥需要自行设置，建议使用32位随机字符串
      api-v3-key: ${WECHAT_PAY_API_V3_KEY:}
      # 商户证书序列号
      # 获取方式：登录微信支付商户平台 > 账户中心 > API安全 > 申请API证书 > 查看证书序列号
      # 或使用命令：openssl x509 -in apiclient_cert.pem -noout -serial
      cert-serial-no: ${WECHAT_PAY_CERT_SERIAL_NO:}
      # 商户私钥路径（apiclient_key.pem 文件路径，优先使用）
      # 获取方式：登录微信支付商户平台 > 账户中心 > API安全 > 申请API证书 > 下载证书
      # 注意：私钥文件需要妥善保管，不要泄露
      private-key-path: ${WECHAT_PAY_PRIVATE_KEY_PATH:}
      # 商户私钥字符串（如果不使用文件路径，可直接配置私钥内容）
      # 注意：privateKeyPath 和 privateKeyString 二选一，优先使用 privateKeyPath
      private-key-string: ${WECHAT_PAY_PRIVATE_KEY_STRING:}
      # 默认回调地址（当 PaymentChannelConfig.notifyUrl 为空时使用）
      # 格式：https://yourdomain.com/api/payment/wechat/callback
      default-notify-url: ${WECHAT_PAY_DEFAULT_NOTIFY_URL:}
  
  wxjava:
    # 是否启用 WxJava SDK（与 open-platform.enabled 保持一致）
    enabled: ${WECHAT_WXJAVA_ENABLED:true}

logging:
  level:
    com.bluecone.app.infra.outbox: WARN
