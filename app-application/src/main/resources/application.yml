server:
  port: 80

# Spring Boot Actuator 配置
management:
  endpoints:
    web:
      # 自定义 Actuator 端点路径，避免与业务路由冲突
      base-path: /internal/actuator
      # 暴露的端点：health（健康检查）、info（应用信息）、prometheus（Prometheus 指标）
      exposure:
        include: health,info,prometheus,metrics
  endpoint:
    health:
      # 显示详细健康信息（仅内网可见，通过 SecurityConfig 限制）
      show-details: when-authorized
      # 健康检查探针配置（K8s liveness/readiness）
      probes:
        enabled: true
    prometheus:
      # 启用 Prometheus 端点
      enabled: true
  # Micrometer 指标配置
  metrics:
    export:
      prometheus:
        enabled: true
    # 启用 JVM 和系统指标
    enable:
      jvm: true
      process: true
      system: true
      tomcat: true
      logback: true
    # 指标标签配置
    tags:
      application: ${spring.application.name}
      environment: ${spring.profiles.active:default}

spring:
  application:
    name: bluecone-app
  
  # Flyway 数据库迁移配置
  # 注意：此配置为通用配置，各环境（dev/prod）会覆盖为严格模式，local 环境允许容错
  flyway:
    # 迁移校验：开启后会在迁移前校验脚本完整性，确保可重复、可校验
    # 安全原因：生产环境必须开启校验，避免数据库状态不一致导致的数据问题
    validate-on-migrate: true
    # 历史库处理：如果数据库已有数据但未使用 Flyway，自动创建 baseline
    # 可运维性：支持从已有数据库迁移到 Flyway 管理
    baseline-on-migrate: true
    # 允许乱序执行迁移（处理历史库中缺失的旧迁移脚本）
    # 可回滚性：允许在历史库中补充缺失的迁移脚本
    out-of-order: true
    # 注意：ignore-migration-patterns 仅在 local 环境配置，dev/prod 环境禁止忽略缺失迁移
    # 原因：线上环境必须保证迁移脚本的完整性和可重复性，禁止忽略缺失迁移

  # 数据源配置：所有敏感信息通过环境变量注入
  datasource:
    # 数据库连接 URL：通过环境变量 DB_URL 注入，默认连接本地数据库（开发环境）
    url: ${DB_URL:jdbc:mysql://localhost:3306/bluecone?useSSL=false&serverTimezone=Asia/Shanghai&characterEncoding=utf8}
    # 数据库用户名：通过环境变量 DB_USERNAME 注入，默认 root（开发环境）
    username: ${DB_USERNAME:root}
    # 数据库密码：通过环境变量 DB_PASSWORD 注入，无默认值（开发环境可为空）
    password: ${DB_PASSWORD:}
    driver-class-name: com.mysql.cj.jdbc.Driver
    # 连接池配置：通用配置，各环境可根据需要覆盖
    hikari:
      maximum-pool-size: 10
      minimum-idle: 2
      idle-timeout: 600000
      max-lifetime: 1800000
      connection-timeout: 30000

  # Redis 配置：所有敏感信息通过环境变量注入
  data:
    redis:
      # Redis 主机地址：通过环境变量 REDIS_HOST 注入，默认 localhost（开发环境）
      host: ${REDIS_HOST:localhost}
      # Redis 端口：通过环境变量 REDIS_PORT 注入，默认 6379
      port: ${REDIS_PORT:6379}
      # Redis 数据库编号：通过环境变量 REDIS_DATABASE 注入，默认 0
      database: ${REDIS_DATABASE:0}
      # Redis 用户名：通过环境变量 REDIS_USERNAME 注入（可选，无默认值）
      username: ${REDIS_USERNAME:}
      # Redis 密码：通过环境变量 REDIS_PASSWORD 注入，无默认值（开发环境可为空）
      password: ${REDIS_PASSWORD:}


mybatis-plus:
  enabled: true

# BlueCone 应用自定义配置
bluecone:
  # ============================================================================
  # ID 生成配置（支持 ULID + Long ID + Public ID）
  # ============================================================================
  id:
    enabled: true
    long:
      enabled: true
      strategy: SNOWFLAKE  # 使用 Snowflake 模式（零配置可用）
      # node-id 会自动派生，多实例部署时需要显式配置
      epoch-millis: 1704067200000  # 2024-01-01T00:00:00Z
    segment:
      enabled: false  # 号段模式需要数据库表支持，默认关闭
      step: 1000  # 每次分配 1000 个 ID
    public-id:
      enabled: true
      separator: "_"  # Public ID 分隔符，格式：tnt_01HN8X5K9G3QRST2VW4XYZ
  
  # 安全配置：JWT Token 和 Gateway 签名密钥
  security:
    token:
      # JWT 签名密钥：通过环境变量 JWT_SECRET 注入，无默认值（安全：密钥必须显式配置）
      # 风险：如果未配置，应用将使用默认开发密钥（仅用于开发环境，生产环境必须配置）
      secret: ${JWT_SECRET:}
      access-token-ttl-minutes: 15
      refresh-token-ttl-days: 7
  
  # Gateway 配置
  gateway:
    enabled: true
    # Gateway 签名密钥：通过环境变量 GATEWAY_SIGNATURE_SECRET 注入，无默认值（安全：密钥必须显式配置）
    # 风险：如果未配置，应用将使用默认开发密钥（仅用于开发环境，生产环境必须配置）
    signature-secret: ${GATEWAY_SIGNATURE_SECRET:}
    signature-tolerance-seconds: 300

  # 缓存配置：通用配置
  cache:
    l1:
      max-size: 20000
    l2:
      enabled: true
    consistency:
      redis:
        enabled: true
    profiles:
      user-profile:
        ttl-seconds: 600
        cache-null: true
      order-detail:
        ttl-seconds: 180
        strong-consistency: true
      tenant-config:
        ttl-seconds: 1800
        cache-null: false

  # Outbox 事件发布配置：通用配置
  outbox:
    enabled: true
    publish-cron: "0/5 * * * * ?"    # 调试时 5 秒扫描一次
    clean-cron: "0 0 3 * * ?"        # 每日 3 点清理 DONE/DEAD
    max-retries: 5
    base-delay-seconds: 1
    max-delay-seconds: 300
    backoff-multiplier: 2.0
    dispatch-batch-size: 100
    clean-retention-days: 7
    consumption-dedup-days: 7

  # 对象存储配置：所有敏感信息通过环境变量注入
  storage:
    provider: ALIYUN_OSS
    aliyun:
      # OSS 端点地址：通过环境变量 OSS_ENDPOINT 注入，无默认值（安全：避免使用默认端点）
      endpoint: ${OSS_ENDPOINT:}
      # OSS Access Key ID：通过环境变量 OSS_ACCESS_KEY_ID 注入，无默认值（安全：密钥必须显式配置）
      access-key-id: ${OSS_ACCESS_KEY_ID:}
      # OSS Access Key Secret：通过环境变量 OSS_ACCESS_KEY_SECRET 注入，无默认值（安全：密钥必须显式配置）
      access-key-secret: ${OSS_ACCESS_KEY_SECRET:}
      # OSS 默认 Bucket：通过环境变量 OSS_BUCKET 注入，无默认值（安全：避免使用默认 Bucket）
      default-bucket: ${OSS_BUCKET:}
      default-expire-seconds: 600
      # OSS CDN 域名：通过环境变量 OSS_CDN_DOMAIN 注入，无默认值
      cdn-domain: ${OSS_CDN_DOMAIN:}
      # OSS 公共域名：通过环境变量 OSS_PUBLIC_DOMAIN 注入，无默认值
      public-domain: ${OSS_PUBLIC_DOMAIN:}

  resource:
    quota:
      default-daily-upload-count-limit: 2000
      default-daily-upload-bytes-limit: 10737418240
      tenant-overrides:
        1001:
          daily-upload-count-limit: 10000
          daily-upload-bytes-limit: 53687091200
        1002:
          daily-upload-count-limit: 500
          daily-upload-bytes-limit: 1073741824

  log:
    enabled: false

# 微信开放平台配置
wechat:
  open-platform:
    # 是否启用微信开放平台功能（本地开发可设为 false 使用 Stub）
    enabled: ${WECHAT_OPEN_PLATFORM_ENABLED:true}
    # 第三方平台 appid
    component-app-id: ${WECHAT_COMPONENT_APP_ID:}
    # 第三方平台 appsecret
    component-app-secret: ${WECHAT_COMPONENT_APP_SECRET:}
    # 消息校验 Token
    component-token: ${WECHAT_COMPONENT_TOKEN:}
    # 消息加解密 Key
    component-aes-key: ${WECHAT_COMPONENT_AES_KEY:}
  
  # 微信支付服务商模式配置
  pay:
    partner:
      # 是否启用微信支付服务商模式（本地开发可设为 false）
      enabled: ${WECHAT_PAY_PARTNER_ENABLED:false}
      # 服务商应用 AppID（sp_appid）
      sp-app-id: ${WECHAT_PAY_SP_APP_ID:}
      # 服务商商户号（sp_mchid）
      sp-mch-id: ${WECHAT_PAY_SP_MCH_ID:}
      # 微信支付 V3 API 密钥（32位，用于回调解密）
      api-v3-key: ${WECHAT_PAY_API_V3_KEY:}
      # 商户证书序列号
      cert-serial-no: ${WECHAT_PAY_CERT_SERIAL_NO:}
      # 商户私钥路径（apiclient_key.pem 文件路径，优先使用）
      private-key-path: ${WECHAT_PAY_PRIVATE_KEY_PATH:}
      # 商户私钥字符串（如果不使用文件路径，可直接配置私钥内容）
      private-key-string: ${WECHAT_PAY_PRIVATE_KEY_STRING:}
      # 默认回调地址（当 PaymentChannelConfig.notifyUrl 为空时使用）
      default-notify-url: ${WECHAT_PAY_DEFAULT_NOTIFY_URL:}
  
  wxjava:
    # 是否启用 WxJava SDK（与 open-platform.enabled 保持一致）
    enabled: ${WECHAT_WXJAVA_ENABLED:true}

logging:
  level:
    com.bluecone.app.infra.outbox: WARN
